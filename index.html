<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng C·ª• Ghi M√†n H√¨nh & Ch·ª•p Ghi Ch√∫ H·ªçc T·∫≠p</title>
    <!-- T·∫£i Tailwind CSS ƒë·ªÉ t·∫°o giao di·ªán ƒë·∫πp v√† responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        /* ·∫®n video element ban ƒë·∫ßu */
        #screenPreview {
            display: none;
            width: 100%;
            max-height: 50vh; /* Gi·ªõi h·∫°n chi·ªÅu cao xem tr∆∞·ªõc */
        }
        /* T√πy ch·ªânh n√∫t */
        .btn-primary {
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="container bg-white p-6 rounded-xl shadow-2xl border border-gray-100">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
            C√¥ng C·ª• Ghi M√†n H√¨nh H·ªçc T·∫≠p
        </h1>
        <p class="text-gray-600 mb-6">
            Ch·ªçn m√†n h√¨nh ƒë·ªÉ chia s·∫ª v√† b·∫Øt ƒë·∫ßu ghi l·∫°i. Nh·∫•n "Ch·ª•p M√†n H√¨nh" khi gi√°o vi√™n y√™u c·∫ßu ghi ch√∫.
        </p>

        <!-- Th√¥ng b√°o Tr·∫°ng th√°i -->
        <div id="statusMessage" class="mb-4 p-3 text-sm rounded-lg text-blue-800 bg-blue-50 hidden">
            ƒêang ch·ªù b·∫°n b·∫Øt ƒë·∫ßu gi√°m s√°t...
        </div>

        <!-- V√πng Xem Tr∆∞·ªõc & Canvas ·∫®n -->
        <div class="relative mb-6 bg-gray-900 rounded-xl overflow-hidden shadow-inner">
            <video id="screenPreview" autoplay muted class="rounded-xl"></video>
            <canvas id="screenshotCanvas" class="hidden"></canvas>
            <div id="noStreamMessage" class="flex items-center justify-center h-48 text-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1v-3m-6.447-2.83A7.995 7.995 0 0112 5a7.995 7.995 0 016.447 9.17l-3.21 1.605a.86.86 0 01-.894 0L12 15l-1.574.787a.86.86 0 01-.894 0L9.243 14.17z" />
                </svg>
                Ch·ªçn "B·∫Øt ƒê·∫ßu" ƒë·ªÉ ch·ªçn m√†n h√¨nh c·∫ßn chia s·∫ª.
            </div>
        </div>

        <!-- Khu v·ª±c ƒêi·ªÅu khi·ªÉn -->
        <div class="flex flex-wrap gap-4 mb-8 justify-center">
            <button id="startButton" class="btn-primary px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 disabled:opacity-50">
                <span class="mr-2">‚ñ∂Ô∏è</span> B·∫Øt ƒê·∫ßu Gi√°m S√°t
            </button>
            
            <!-- N√∫t m√¥ ph·ªèng AI ch·ª•p m√†n h√¨nh khi c√≥ l·ªánh "Ch√©p b√†i" -->
            <button id="screenshotButton" class="btn-primary px-6 py-3 bg-yellow-500 text-gray-900 rounded-lg font-semibold hover:bg-yellow-600 disabled:opacity-50" disabled>
                <span class="mr-2">üì∏</span> Ch·ª•p M√†n H√¨nh Ngay (Ghi Ch√∫)
            </button>
            
            <button id="stopButton" class="btn-primary px-6 py-3 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 disabled:opacity-50" disabled>
                <span class="mr-2">üõë</span> D·ª´ng & Ho√†n Th√†nh
            </button>
            
            <button id="downloadRecordingButton" class="btn-primary px-6 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 disabled:opacity-50" disabled>
                <span class="mr-2">‚¨áÔ∏è</span> T·∫£i Video Ghi L·∫°i
            </button>
        </div>

        <!-- Khu v·ª±c Hi·ªÉn th·ªã ·∫¢nh Ch·ª•p -->
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">
            ·∫¢nh Ch·ª•p Ghi Ch√∫ ƒê√£ L∆∞u
        </h2>
        <div id="screenshotsContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
            <p id="noScreenshotsMessage" class="text-gray-500 italic col-span-full">
                Ch∆∞a c√≥ ·∫£nh ch·ª•p n√†o ƒë∆∞·ª£c l∆∞u.
            </p>
        </div>

        <div class="mt-8 pt-4 border-t text-sm text-gray-500">
            <p>
                *L∆∞u √Ω: ƒê·ªÉ c√≥ t√≠nh nƒÉng AI nh·∫≠n di·ªán gi·ªçng n√≥i ti·∫øng Vi·ªát t·ª± ƒë·ªông, c·∫ßn c√≥ m·ªôt d·ªãch v·ª• m√°y ch·ªß chuy√™n d·ª•ng. Phi√™n b·∫£n n√†y s·ª≠ d·ª•ng n√∫t b·∫•m th·ªß c√¥ng ƒë·ªÉ thay th·∫ø.
            </p>
            <p>
                **M·∫πo: B·∫°n c√≥ th·ªÉ nh·∫•n ph√≠m **'S'** ƒë·ªÉ ch·ª•p m√†n h√¨nh nhanh thay v√¨ nh·∫•n n√∫t.
            </p>
        </div>
    </div>

    <script>
        // Khai b√°o c√°c bi·∫øn to√†n c·ª•c
        let screenStream = null; // Lu·ªìng chia s·∫ª m√†n h√¨nh
        let mediaRecorder = null; // ƒê·ªëi t∆∞·ª£ng ghi ph∆∞∆°ng ti·ªán
        let recordedChunks = []; // M·∫£ng ch·ª©a c√°c ƒëo·∫°n d·ªØ li·ªáu video
        let isRecording = false;
        
        // L·∫•y c√°c ph·∫ßn t·ª≠ DOM
        const statusMessage = document.getElementById('statusMessage');
        const screenPreview = document.getElementById('screenPreview');
        const noStreamMessage = document.getElementById('noStreamMessage');
        const screenshotCanvas = document.getElementById('screenshotCanvas');
        const screenshotsContainer = document.getElementById('screenshotsContainer');
        const noScreenshotsMessage = document.getElementById('noScreenshotsMessage');

        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const screenshotButton = document.getElementById('screenshotButton');
        const downloadRecordingButton = document.getElementById('downloadRecordingButton');

        /**
         * H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i giao di·ªán ng∆∞·ªùi d√πng
         * @param {string} message - Tin nh·∫Øn tr·∫°ng th√°i
         * @param {string} type - Lo·∫°i th√¥ng b√°o (v√≠ d·ª•: 'info', 'success', 'error')
         */
        function updateStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'text-blue-800', 'bg-blue-50', 'text-red-800', 'bg-red-50', 'text-green-800', 'bg-green-50');
            
            if (type === 'info') {
                statusMessage.classList.add('text-blue-800', 'bg-blue-50');
            } else if (type === 'success') {
                statusMessage.classList.add('text-green-800', 'bg-green-50');
            } else if (type === 'error') {
                statusMessage.classList.add('text-red-800', 'bg-red-50');
            }
        }

        /**
         * B·∫Øt ƒë·∫ßu gi√°m s√°t (chia s·∫ª m√†n h√¨nh v√† ghi video)
         */
        async function startMonitoring() {
            updateStatus('ƒêang y√™u c·∫ßu quy·ªÅn chia s·∫ª m√†n h√¨nh...', 'info');
            try {
                // Y√™u c·∫ßu quy·ªÅn chia s·∫ª m√†n h√¨nh
                screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: true, 
                    audio: true // T√πy ch·ªçn bao g·ªìm c·∫£ √¢m thanh h·ªá th·ªëng
                });
                
                if (!screenStream) {
                    throw new Error("Ng∆∞·ªùi d√πng ƒë√£ h·ªßy chia s·∫ª m√†n h√¨nh.");
                }

                screenPreview.srcObject = screenStream;
                screenPreview.style.display = 'block';
                noStreamMessage.classList.add('hidden');
                
                // C√†i ƒë·∫∑t Media Recorder
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(screenStream, { 
                    mimeType: 'video/webm; codecs=vp8' 
                });

                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    isRecording = false;
                    updateStatus('Ho√†n th√†nh ghi m√†n h√¨nh. S·∫µn s√†ng ƒë·ªÉ t·∫£i xu·ªëng.', 'success');
                    downloadRecordingButton.disabled = false;
                    startButton.disabled = false;
                    stopButton.disabled = true;
                    screenshotButton.disabled = true;
                };

                mediaRecorder.start(1000); // Ghi d·ªØ li·ªáu m·ªói 1000ms
                isRecording = true;

                // Thi·∫øt l·∫≠p l·∫Øng nghe khi ng∆∞·ªùi d√πng d·ª´ng chia s·∫ª (n√∫t Stop ·ªü tr√¨nh duy·ªát)
                const track = screenStream.getVideoTracks()[0];
                if (track) {
                    track.onended = stopMonitoring;
                }

                updateStatus('ƒêang Gi√°m S√°t v√† Ghi H√¨nh. B·∫•m "Ch·ª•p M√†n H√¨nh Ngay" ƒë·ªÉ l∆∞u ghi ch√∫.', 'success');
                startButton.disabled = true;
                stopButton.disabled = false;
                screenshotButton.disabled = false;

            } catch (err) {
                console.error("L·ªói khi b·∫Øt ƒë·∫ßu gi√°m s√°t:", err);
                updateStatus(`L·ªói: ${err.message || 'Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu chia s·∫ª m√†n h√¨nh. Vui l√≤ng th·ª≠ l·∫°i.'}`, 'error');
                resetState();
            }
        }

        /**
         * D·ª´ng gi√°m s√°t (d·ª´ng chia s·∫ª m√†n h√¨nh v√† ghi video)
         */
        function stopMonitoring() {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
            } else {
                // N·∫øu d·ª´ng m√† kh√¥ng c√≥ ghi h√¨nh (tr∆∞·ªùng h·ª£p l·ªói)
                resetState();
            }
            
            screenPreview.style.display = 'none';
            screenPreview.srcObject = null;
            noStreamMessage.classList.remove('hidden');
        }

        /**
         * Thi·∫øt l·∫≠p l·∫°i tr·∫°ng th√°i giao di·ªán v√† bi·∫øn
         */
        function resetState() {
            isRecording = false;
            startButton.disabled = false;
            stopButton.disabled = true;
            screenshotButton.disabled = true;
            updateStatus('ƒê√£ d·ª´ng gi√°m s√°t. Vui l√≤ng nh·∫•n "B·∫Øt ƒê·∫ßu" ƒë·ªÉ h·ªçc bu·ªïi m·ªõi.', 'info');
        }

        /**
         * Ch·ª•p m·ªôt khung h√¨nh t·ª´ lu·ªìng video ƒëang ch·∫°y v√† hi·ªÉn th·ªã
         */
        function takeScreenshot() {
            if (!screenStream) {
                updateStatus('L·ªói: B·∫°n ch∆∞a b·∫Øt ƒë·∫ßu chia s·∫ª m√†n h√¨nh.', 'error');
                return;
            }
            
            // ƒê·∫£m b·∫£o video ƒëang c√≥ d·ªØ li·ªáu ƒë·ªÉ v·∫Ω
            if (screenPreview.readyState < 2) {
                updateStatus('Video ch∆∞a s·∫µn s√†ng ƒë·ªÉ ch·ª•p. Vui l√≤ng ƒë·ª£i m·ªôt ch√∫t.', 'error');
                return;
            }
            
            const video = screenPreview;
            const canvas = screenshotCanvas;
            const context = canvas.getContext('2d');

            // Thi·∫øt l·∫≠p k√≠ch th∆∞·ªõc canvas b·∫±ng k√≠ch th∆∞·ªõc video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // V·∫Ω khung h√¨nh hi·ªán t·∫°i l√™n canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Chuy·ªÉn canvas th√†nh URL ·∫£nh (base64)
            const imageDataUrl = canvas.toDataURL('image/png');
            
            // Hi·ªÉn th·ªã ·∫£nh ch·ª•p
            displayScreenshot(imageDataUrl);
            updateStatus('ƒê√£ ch·ª•p ghi ch√∫ th√†nh c√¥ng!', 'info');
        }

        /**
         * Hi·ªÉn th·ªã ·∫£nh ch·ª•p l√™n giao di·ªán ng∆∞·ªùi d√πng
         * @param {string} dataUrl - D·ªØ li·ªáu base64 c·ªßa ·∫£nh
         */
        function displayScreenshot(dataUrl) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN');
            
            // X√≥a th√¥ng b√°o "ch∆∞a c√≥ ·∫£nh" n·∫øu ƒë√¢y l√† ·∫£nh ƒë·∫ßu ti√™n
            if (noScreenshotsMessage) {
                 noScreenshotsMessage.classList.add('hidden');
            }

            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-[1.02] transition duration-300';
            card.innerHTML = `
                <img src="${dataUrl}" alt="·∫¢nh ch·ª•p ghi ch√∫" class="w-full h-auto object-cover border-b">
                <div class="p-3">
                    <p class="text-xs font-medium text-indigo-600">Ghi ch√∫ l√∫c: ${timeString}</p>
                    <a href="${dataUrl}" download="GhiChu_${now.getTime()}.png" 
                       class="mt-2 inline-block text-sm text-green-600 hover:text-green-800 font-semibold transition duration-150">
                        T·∫£i Xu·ªëng (PNG)
                    </a>
                </div>
            `;
            screenshotsContainer.prepend(card); // Th√™m ·∫£nh ch·ª•p m·ªõi nh·∫•t l√™n ƒë·∫ßu
        }

        /**
         * T·∫£i xu·ªëng video ƒë√£ ghi l·∫°i
         */
        function downloadRecording() {
            if (recordedChunks.length === 0) {
                updateStatus('Kh√¥ng c√≥ d·ªØ li·ªáu video ƒë·ªÉ t·∫£i xu·ªëng.', 'error');
                return;
            }

            const blob = new Blob(recordedChunks, {
                type: 'video/webm'
            });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `BuoiHoc_${new Date().getTime()}.webm`;
            document.body.appendChild(a);
            a.click();
            
            // D·ªçn d·∫πp
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            updateStatus('ƒê√£ t·∫°o li√™n k·∫øt t·∫£i xu·ªëng video. Vui l√≤ng ki·ªÉm tra th∆∞ m·ª•c t·∫£i xu·ªëng.', 'success');
        }

        // --- Thi·∫øt l·∫≠p s·ª± ki·ªán ---
        window.onload = function() {
            // Thi·∫øt l·∫≠p c√°c n√∫t b·∫•m
            startButton.addEventListener('click', startMonitoring);
            stopButton.addEventListener('click', stopMonitoring);
            screenshotButton.addEventListener('click', takeScreenshot);
            downloadRecordingButton.addEventListener('click', downloadRecording);

            // Ph√≠m t·∫Øt (Hotkeys)
            document.addEventListener('keydown', (event) => {
                if (event.key === 's' || event.key === 'S') {
                    if (!screenshotButton.disabled) {
                         event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh ƒë·ªông m·∫∑c ƒë·ªãnh c·ªßa tr√¨nh duy·ªát
                         takeScreenshot();
                         // TƒÉng th√™m ph·∫£n h·ªìi th·ªã gi√°c
                         screenshotButton.classList.add('animate-pulse');
                         setTimeout(() => {
                             screenshotButton.classList.remove('animate-pulse');
                         }, 200);
                    }
                }
            });
            
            updateStatus('S·∫µn s√†ng. Nh·∫•n "B·∫Øt ƒê·∫ßu Gi√°m S√°t" ƒë·ªÉ ch·ªçn m√†n h√¨nh h·ªçc t·∫≠p c·ªßa b·∫°n.', 'info');
        }
    </script>
</body>
</html>
